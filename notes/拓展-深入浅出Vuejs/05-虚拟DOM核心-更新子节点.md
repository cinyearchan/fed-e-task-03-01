# 更新子节点

当新节点的子节点和旧节点的子节点都存在并且不相同时，会进行子节点的更新操作，大致分为4中操作：

- 更新节点
- 新增节点
- 删除节点
- 移动节点位置

因此，更新子节点更多的是讨论

- 什么情况下需要更新节点
- 什么情况下需要新增节点 等



对比两个子节点列表（children），首先需要做的是循环

1. 循环 newChildren（新子节点列表）
2. 每循环到一个新子节点，就去 oldChildren（旧子节点列表）中找到和当前节点相同的那个旧子节点
   - 如果在 oldChildren 中找不到，说明当前子节点是由于状态变化而新增的节点，要进行创建节点并插入视图的操作
   - 如果找到了，就做更新操作
     - 如果找到的旧子节点的位置和新子节点不同，需要移动节点 等



## 更新策略

1. ### 创建子节点

   新旧两个子节点列表是通过循环进行比对的，所以创建节点的操作是在循环内执行的，其具体实现是在 oldChildren（旧子节点列表）中寻找本次循环所指向的新子节点

   如果在 oldChildren 中没有找到与本次循环所指向的新子节点相同的节点，说明该新子节点是一个新增节点——需要执行创建节点的操作，并将新创建的节点插入到 oldChildren 中**所有未处理节点（未处理就是没有进行任何更新操作的节点）的前面**

   当节点成功插入 DOM 后，这一轮的循环就结束了

   

   > 为什么要插入到 oldChildren 中**所有未处理节点的前面**？
   >
   > 插入到所有已处理节点的后面不也行吗？不行！如果这个新节点后面也是一个新增节点呢？

   **注意：我们是使用虚拟节点进行对比，而不是真实 DOM 节点做对比**

   以插入到所有已处理节点的后面为例：假设有两个新节点，新节点1和新节点2

   在经过对比之后，新节点1被插入到所有已处理节点的后面，有（已处理、已处理、新节点1）

   此时，对比新节点2，同样在 oldChildren 中找不到新节点2，要执行创建并插入，理想情况下，执行完毕后，应有（已处理、已处理、新节点1、新节点2）

   但是，oldChildren 中不存在 新节点1，在对 新节点2 进行处理时，插入到所有已处理节点的后面，则有（已处理、已处理、新节点2、新节点1）

   **所以用插入到已处理节点后面这样的逻辑来插入节点，就会插入一个错误的位置**

   > **谨记：对比时以 vnode 为准，以 vnode 为目标，vnode 与 oldVnode 对比，对比只是手段，对比之后操作的结果，应该与 vnode 一致**
   
2. ### 更新子节点

   更新节点本质上是当一个节点同时存在于 newChildren 和 oldChildren 中时需要执行的操作

   - 新旧两个子节点是同一个节点并且位置相同，只需要进行[更新节点的操作](https://github.com/cinyearchan/fed-e-task-03-01/blob/master/notes/%E6%8B%93%E5%B1%95-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAVuejs/04-%E8%99%9A%E6%8B%9FDOM%E6%A0%B8%E5%BF%83.md#%E6%9B%B4%E6%96%B0%E8%8A%82%E7%82%B9)
   - 如果 oldChildren 中子节点的位置和本次循环所指向的新子节点的位置不一致时，除了对真实 DOM 节点进行更新操作外，还需对这个真实 DOM 节点进行移动节点的操作

3. ### 移动子节点

   移动节点通常发生在 newChildren 中的某个节点和 oldChildren 中的某个节点是同一个节点，但位置不同，所以在真实 DOM 中需要将这个节点的位置以**新虚拟节点**的位置为基准进行移动

   通过 Node.insertBefore() 方法，可以成功地将一个已有节点移动到一个指定的位置

   > 如何得知新虚拟节点的位置是哪里？即怎么知道应该把节点移动到哪里呢？

   - 对比两个子节点列表是通过从左往右循环 newChildren 这个列表
   - 每循环一个节点，就去 oldChildren 中寻找与这个节点相同的节点进行处理
   - 因此，newChildren 中当前被循环到的这个节点的左边都是被处理过的
   - 故而这个节点的位置是所有未处理节点的第一个节点

   **只要把需要移动的节点移动到所有未处理节点的最前面**

4. ### 删除子节点

   删除子节点，本质上是删除那些 oldChildren 中存在但 newChildren 中不存在的节点

   **当 newChildren 中的所有节点都被循环了一遍后，也就是循环结束后，如果 oldChildren 中还有剩余的没有被处理的节点，那么这些节点就是被废弃、需要删除的节点**



---

## 优化策略





































